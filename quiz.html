<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CYSA+ 練習平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #sidebar {
      width: 13rem;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans">

  <!-- Sidebar -->
  <div id="sidebar" class="fixed left-0 top-0 h-full w-52 bg-slate-800 text-white p-4 overflow-y-auto">
    <h2 class="font-bold mb-3">題目</h2>
    <div id="questionList"></div>
  </div>

  <!-- Main -->
  <div class="ml-56 p-6 flex justify-center">
    <div class="bg-white shadow-xl rounded-xl p-6 w-full max-w-4xl">
      <h1 class="text-2xl font-bold mb-4 text-center">CYSA+ 練習平台</h1>

      <!-- Auth Panel -->
      <div id="authPanel" class="mb-4">
        <input id="authEmail" type="email" placeholder="Email" class="border p-1 rounded w-full mb-1">
        <input id="authPassword" type="password" placeholder="密碼" class="border p-1 rounded w-full mb-1">
        <div class="flex gap-2">
          <button id="registerBtn" class="bg-green-600 text-white px-3 py-1 rounded flex-1">註冊</button>
          <button id="loginBtn" class="bg-blue-600 text-white px-3 py-1 rounded flex-1">登入</button>
          <button id="logoutBtn" class="bg-gray-400 text-white px-3 py-1 rounded flex-1">登出</button>
        </div>
        <div id="authMessage" class="mt-2 text-sm text-red-600 text-center"></div>
      </div>

      <!-- Question Area -->
      <div id="qIndex" class="text-sm text-gray-600 mb-2"></div>
      <div id="questionArea" class="mt-4"></div>
      <div id="options" class="mt-4 break-words"></div>
      <div class="flex justify-end mt-2">
        <button id="submitAnswerBtn" class="bg-blue-600 text-white px-3 py-1 rounded">提交答案</button>
      </div>
      <div id="feedback" class="mt-4 text-sm"></div>

      <div class="flex gap-2 mt-4">
        <button id="markBtn" class="border px-3 py-1 rounded">☆ 標記/取消</button>
      </div>

      <div class="mt-6 flex justify-between items-center">
        <div>得分：<span id="score">0</span></div>
        <div class="flex gap-2">
          <button id="prevBtn" class="border px-3 py-1 rounded">上一題</button>
          <button id="nextBtn" class="bg-blue-600 text-white px-3 py-1 rounded">下一題</button>
          <button id="submitBtn" class="border px-3 py-1 rounded">提交</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

    // ---------------- Firebase Config ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyDGAv2qFY2AMQipQLMXviKQYsCLqS3tihQ",
      authDomain: "cysaquiz.firebaseapp.com",
      databaseURL: "https://cysaquiz-default-rtdb.firebaseio.com",
      projectId: "cysaquiz",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ---------------- State ----------------
    let QUESTIONS = {{ questions | tojson }};
    let current = {{ index }};
    let score = 0;
    let answered = {};
    let marks = {};
    let user = null;
    let idToken = null;

    // ---------------- DOM ----------------
    const qIndexEl = document.getElementById("qIndex");
    const questionArea = document.getElementById("questionArea");
    const optionsEl = document.getElementById("options");
    const feedbackEl = document.getElementById("feedback");
    const scoreEl = document.getElementById("score");
    const markBtn = document.getElementById("markBtn");
    const questionListEl = document.getElementById("questionList");
    const submitAnswerBtn = document.getElementById("submitAnswerBtn");

    // ---------------- Functions ----------------
    async function loadProgress() {
      if (!idToken) return;
      const res = await fetch("/api/progress", { headers: { "Authorization": "Bearer " + idToken } });
      const data = await res.json();
      answered = data.answers || {};
      marks = data.marks || {};
      score = data.score || 0;
      scoreEl.innerText = score;
      renderSidebar();
    }

    function renderSidebar() {
      questionListEl.innerHTML = "";
      QUESTIONS.forEach((q, i) => {
        const btn = document.createElement("button");
        btn.innerText = `題目 ${i + 1}`;
        btn.className = "w-full text-left px-2 py-1 mb-1 rounded ";
        if (marks[i]) btn.className += " bg-yellow-500 text-black";
        else if (answered[i]) btn.className += " bg-green-600 text-white";
        else btn.className += " bg-slate-700 hover:bg-slate-600";
        btn.onclick = () => { current = i; render(); };
        questionListEl.appendChild(btn);
      });
    }

    function render() {
      const q = QUESTIONS[current];
      qIndexEl.innerText = `題目 ${current + 1} / ${QUESTIONS.length}`;
      questionArea.innerHTML = q.html;
      optionsEl.innerHTML = "";
      feedbackEl.innerHTML = "";

      // 支援任意字母選項 A-Z
      const optPs = Array.from(questionArea.querySelectorAll("p")).filter(p => /^[A-Z]\./.test(p.innerText));
      optPs.forEach(p => {
        const key = p.innerText[0];
        const div = document.createElement("div");
        div.className = "flex items-start mt-2"; // 改成 items-start
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = key;
        checkbox.id = `opt-${key}`;
        checkbox.className = "mr-2 mt-1 flex-shrink-0"; // 防止縮掉
        const label = document.createElement("label");
        label.htmlFor = `opt-${key}`;
        label.innerText = p.innerText;
        label.className = "break-words"; // 自動換行
        div.appendChild(checkbox);
        div.appendChild(label);
        optionsEl.appendChild(div);
      });


      renderSidebar();
    }

    async function submitAnswer() {
      const checkboxes = optionsEl.querySelectorAll("input[type='checkbox']");
      const selected = Array.from(checkboxes).filter(c => c.checked).map(c => c.value).join('');
      if (selected.length === 0) {
        feedbackEl.innerHTML = `<div class="p-3 rounded bg-yellow-100">請至少選擇一個答案</div>`;
        return;
      }

      const res = await fetch("/api/answer", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": idToken ? "Bearer " + idToken : "" },
        body: JSON.stringify({ idx: current, choice: selected })
      });
      const data = await res.json();
      answered[current] = true;
      score = data.score;
      scoreEl.innerText = score;
      feedbackEl.innerHTML = `
    <div class="p-3 rounded ${data.correct ? "bg-green-100" : "bg-red-100"}">
      ${data.correct ? "✅ 正確" : "❌ 錯誤"} ${data.first_time ? "" : "<span class='text-xs'>(重複作答)</span>"}
      <br>正確答案：${data.answer}
      <div class="mt-2">${data.explanation}</div>
    </div>`;
      renderSidebar();
    }

    async function toggleMark() {
      const mark = !marks[current];
      marks[current] = mark;
      await fetch("/api/mark", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": idToken ? "Bearer " + idToken : "" },
        body: JSON.stringify({ idx: current, mark })
      });
      renderSidebar();
    }

    async function submitQuiz() {
      await fetch("/api/submit", { method: "POST", headers: { "Content-Type": "application/json", "Authorization": idToken ? "Bearer " + idToken : "" }, body: JSON.stringify({ score, total: QUESTIONS.length }) });
      alert(`已提交！得分：${score}/${QUESTIONS.length}`);
    }

    // ---------------- Event ----------------
    document.getElementById("nextBtn").onclick = () => { if (current < QUESTIONS.length - 1) current++; render(); }
    document.getElementById("prevBtn").onclick = () => { if (current > 0) current--; render(); }
    markBtn.onclick = toggleMark;
    document.getElementById("submitBtn").onclick = submitQuiz;
    submitAnswerBtn.onclick = submitAnswer;

    // ---------------- Firebase Auth ----------------
    const emailInput = document.getElementById("authEmail");
    const passwordInput = document.getElementById("authPassword");
    const msgEl = document.getElementById("authMessage");

    document.getElementById("registerBtn").onclick = async () => {
      const email = emailInput.value, pwd = passwordInput.value;
      if (!email || !pwd) { msgEl.innerText = "請填寫 Email 和密碼"; return; }
      try { await createUserWithEmailAndPassword(auth, email, pwd); msgEl.innerText = "註冊成功！"; }
      catch (e) { msgEl.innerText = "註冊失敗：" + e.message; }
    };

    document.getElementById("loginBtn").onclick = async () => {
      const email = emailInput.value, pwd = passwordInput.value;
      if (!email || !pwd) { msgEl.innerText = "請填寫 Email 和密碼"; return; }
      try { await signInWithEmailAndPassword(auth, email, pwd); msgEl.innerText = "登入成功！正在同步進度…"; }
      catch (e) { msgEl.innerText = "登入失敗：" + e.message; }
    };

    document.getElementById("logoutBtn").onclick = async () => {
      try { await signOut(auth); msgEl.innerText = "已登出"; user = null; idToken = null; answered = {}; marks = {}; score = 0; scoreEl.innerText = 0; render(); } catch (e) { }
    };

    // ---------------- Auth State ----------------
    onAuthStateChanged(auth, async (u) => {
      user = u;
      if (user) {
        idToken = await user.getIdToken(true); // 強制刷新 token
        await loadProgress();
      } else {
        idToken = null; answered = {}; marks = {}; score = 0; scoreEl.innerText = 0;
        render();
      }
    });

    // ---------------- Init ----------------
    render();

  </script>
</body>

</html>